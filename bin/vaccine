#!/bin/sh

help() {
  echo "vaccine [options]

Options:
        --name <name>     # Your library's name.
        --src <dir>       # The directory for your sources (default: src).
        --lib <dir>       # The directory for your libraries (default: lib).
        --global <name>   # The global variable name (default: --name)
        --deps <d1,...>   # Comma separated dependencies.
        --dep <d1>        # Single dependency.
"
  exit 0
}

if test "X$vaccine_bin_dir" = X
then
  SOURCE="$0"
  DIR="$( dirname "$SOURCE" )"
  while [ -h "$SOURCE" ]
  do
    SOURCE="$(readlink "$SOURCE")"
    [ "$(echo "$SOURCE" | cut -c 1)" != '/' ] && SOURCE="$DIR/$SOURCE"
    DIR="$( cd -P "$( dirname "$SOURCE"  )" && pwd )"
  done
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

  vaccine_bin_dir=$DIR
  vaccine_src_dir="$(cd "$DIR/../src" && pwd)"
  export vaccine_bin_dir
  export vaccine_src_dir
fi

vaccine_src=$vaccine_src_dir/vaccine.js
standalone_server_src=$vaccine_src_dir/dev_server_standalone.js
build_src=$vaccine_src_dir/build

# Variables
source_dir=src
library_dir=lib

vars_list='lib_name source_dir library_dir global_var dep_name dep_names'


fail() {
  echo $1 >&2
  exit 1
}

while test $# -gt 0
do
  case $1 in
    --help | -h) help ;;
    --name) lib_name=$2 ;;
    --src) dir_or_file=$2; source_dir=$2 ;;
    --lib) library_dir=$2 ;;
    --global) global_var=$2 ;;
    --deps | --dep) dep_names_raw=$2 ;;
    *) fail "Unrecognized option: $1" ;;
  esac
  if test "X$1" = "X--write-exports"
  then
    shift 1
  else
    shift 2
  fi
done


test "X$lib_name" = X && fail 'Must provide the name (vaccine --name [name])'

if test "X$dep_names_raw" != X
then
  has_deps=true
  dep_name=$dep_names_raw
  dep_names=$(echo "$dep_names_raw" | sed -e "s/,/\",\"/g" \
                                          -e "s/^/\"/" -e "s/$/\"/")
  echo "$dep_names" | grep -q ',' && multi_deps=true
fi

test "X$global_var" = X && global_var=$lib_name


conditional() {
  if test "X$2" = 'Xtrue'
  then
    sed "/::::: $1$/,/##### $1$/d" | sed "/!!!!! $1$/,/##### $1$/d"
  else
    #sed "/????? $1$/,/::::: $1$/d" | sed "/????? $1$/,/##### $1$/d"
    awk "/\?\?\?\?\? $1/{f=1} /##### $1/{f=0} /::::: $1/{f=0} f == 0 {print}"
  fi
}

clean() {
  sed -e '/?????/d' -e '/!!!!!/d' -e '/:::::/d' -e '/#####/d'
}

replace_vars() {
  sed_string=''
  for var in $vars_list
  do
    eval value=\$$var
    name=$(echo $var | tr '[a-z]' '[A-Z]')
    sed_string="$sed_string -e 's#{{{ $name }}}#$value#g'"
  done
  eval sed $sed_string
}

start() {
  cat $1 | replace_vars
}

unindent_start() {
  start $1 | sed 's/^    //'
}

set_dependencies() {
  if test "X$has_deps" = X
  then
    conditional MULTI_DEPS false | conditional ONE_DEP false | conditional NO_DEPS true
  else
    if test "X$multi_deps" = X
    then
      conditional MULTI_DEPS false | conditional ONE_DEP true | conditional NO_DEPS false
    else
      conditional MULTI_DEPS true | conditional ONE_DEP false | conditional NO_DEPS false
    fi
  fi
}

start_vaccine() {
  unindent_start $vaccine_src | set_dependencies
}

complex_intermediate() {
  start_vaccine | conditional SIMPLE false
}

simple_intermediate() {
  start_vaccine | conditional SIMPLE true
}


# Vaccines

complex_intermediate | conditional AMD true | clean > vaccine.js
simple_intermediate | conditional AMD true | clean > vaccine_simple.js
complex_intermediate | conditional AMD false | clean > vaccine_no_amd.js
simple_intermediate | conditional AMD false | clean > vaccine_simple_no_amd.js


# Server

start $standalone_server_src | clean > dev_server_standalone_node.js


# Builds

unindent_start $build_src | conditional NODE true | clean > build
chmod +x build

unindent_start $build_src | conditional NODE false | clean > build_node
chmod +x build_node
