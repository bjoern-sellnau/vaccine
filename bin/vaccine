#!/usr/bin/env node

var fs = require('fs'),
    vaccine = require('..');

var usage = 'Generate shims to make CommonJS or AMD work in the browser.\n' +
            'Usage: vaccine --name <name> --main <main> [options]\n\n' +
            '[m] means it is intended to be called multiple times.';

var optimist = require('optimist')
    .usage(usage)
    .wrap(80)

    .describe('name', "Your library's name.")
    .describe('main', "Your library's entry file.")

    .describe('dirs', 'The number of directory *levels* under your source ' +
                      'dir. (e.g. src/foo/*.js + src/bar/*.js + src/baz/*.js ' +
                      'would be 2 directory levels.)')
    .describe('dep', "[m] Your library's dependencies.")
    .describe('support', "[m] Choose between supporting AMD, attaching to " +
                         "'window', or both (default both).")
    .describe('export', "[m] How a module provides exports. Options are " +
                        "'return', 'module' (for module.exports), and " +
                        "'exports'.")
    .describe('target', "[m] Which files to configure. Options are: " +
                         "vaccine.js, build.sh, Makefile, vaccine_debug.js, " +
                         "and dev_server.js. All but dev_server.js are " +
                         "default.")

    .describe('stdout', 'Write to stdout instead of to files.')
    .describe('commonjs', 'Write in CommonJS format. build.sh will wrap the modules.')
    .describe('performance', 'Measure the load-time performance of your library.')
    .describe('debug', 'Add debugging logs for development.')
    .describe('src', 'The directory your sources are under. Derived from --main.')
    .describe('global', 'The global variable name (defaults to --name).')
    .describe('use-strict', 'Enable strict mode in built file.')
    .describe('lib', 'The directory for your libraries.')

    .alias('name', 'n')
    .alias('main', 'm')
    .alias('dep', 'd')
    .alias('support', 's')
    .alias('export', 'e')
    .alias('target', 't')
    .alias('stdout', 'c')
    .alias('help', 'h')

    .demand('name')
    .demand('main')

    .boolean('stdout')
    .boolean('commonjs')
    .boolean('performance')
    .boolean('debug')
    .boolean('use-strict')

    .default('lib', 'lib')
;


var argv = optimist.argv;

if (argv.h) {
  optimist.showHelp();
  process.exit(0);
}

argv.use_strict = argv['use-strict'];

var ensureArray = function(key) {
  if (typeof argv[key] !== 'undefined' && !Array.isArray(argv[key])) {
    return [argv[key]];
  } else {
    return argv[key];
  }
}
argv.dependencies = ensureArray('dep');
argv.targets = ensureArray('target');
argv.supports = ensureArray('support');
argv.exports = ensureArray('export');

vaccine.loadFiles();
var compiled = vaccine(argv),
    targets = Object.keys(compiled);

if (argv.stdout) {
  targets.forEach(function(tgt) {
    if (targets.length > 1) {
      console.log('--------------- ' + tgt + ' ---------------');
    }
    console.log(compiled[tgt]);
  });
} else {
  targets.forEach(function(name) {
    var comp = compiled[name];
    if (name === 'Makefile') {
      var stats = fs.statSync(name);
      if (stats.isFile()) name = 'Makefile.example';
    }
    fs.writeFile(name, comp, 'utf8', function(err) {
      if (err) throw err;
      if (name === 'build.sh') {
        fs.chmod('build.sh', '755', function(err) { if (err) throw err; });
      }
      console.log('Completed... ' + name);
    });
  });
}
