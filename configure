#!/bin/sh

# Configure the dev server, build scripts, and loader for the test sources

# Plain build script
source_dir=test_src
sed "s#cat src/\*#cat $source_dir/*#" build > test/build
chmod +x test/build

# Util build script
source_dir=util_src
sed "s#cat src/\*#cat $source_dir/*#" build > test/build_util
chmod +x test/build_util

# Node build script
source_dir=node_src
app_name=test_app
main=main
vaccine=../vaccine.js
sed "s#source_dir=src#source_dir=$source_dir#" build_node |
    sed "s#app_name=my_app#app_name=$app_name#" |
    sed "s#vaccine=vaccine.js#vaccine=$vaccine#" |
    sed "s#main=my_app_main#main=$main#" > test/build_node
chmod +x test/build_node


# Dev server
server() {
  server_script=$1
  output_file=$2
  build_script=$3
  source_dir=$4
  app_name=$5
  sed "s#outputFile = 'my_app.js'#outputFile = '$output_file'#" $server_script |
      sed "s#sourceDir = 'src'#sourceDir = '$source_dir'#" |
      sed "s#appName = .*;#appName = '$app_name';#" |
      sed "s#buildScript = './build'#buildScript = '$build_script'#"
}

server dev_server_standalone.js test_built.js ./build > test/dev_server_standalone.js
server dev_server_express.js test_built.js ./build > test/dev_server_express.js

server dev_server_standalone.js test_built_node.js ./build_node node_src test_app > test/dev_server_standalone_node.js
server dev_server_express_node.js test_built_node.js ./build_node node_src test_app > test/dev_server_express_node.js


# vaccine loader
loader() {
  source_dir=$1
  lib_dir=$2
  app_name=$3
  main=$4

  sed "s#sourceDir = 'src'#sourceDir = '$source_dir'#" vaccine_loader.js |
      sed "s#libDir = 'lib'#libDir = '$lib_dir'#" |
      sed "s#appName = 'my_app'#appName = '$app_name'#" |
      sed "s#main = 'my_app_main'#main = '$main'#"
}

loader test_src test_lib test_app main > test/vaccine_loader.js
loader node_src test_lib test_app main > test/vaccine_loader_node.js

